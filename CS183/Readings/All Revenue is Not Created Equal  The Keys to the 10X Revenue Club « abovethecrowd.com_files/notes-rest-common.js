var wpNotesCommon;var wpNotesCommentModView;var wpNoteList;var wpNoteModel;(function($){var cookies=document.cookie.split(/;\s*/),cookie=false;for(i=0;i<cookies.length;i++){if(cookies[i].match(/^wp_api=/)){cookies=cookies[i].split('=');cookie=cookies[1];break;}}
wpNotesCommon={noteTypes:{comment:'comment',follow:'follow',like:'like',reblog:'reblog',trophy:['best_liked_day_feat','like_milestone_achievement','achieve_automattician_note','best_followed_day_feat','followed_milestone_achievement']},noteType2Noticon:{'like':'like','follow':'follow','comment_like':'like','comment':'comment','reblog':'reblog','like_milestone_achievement':'trophy','achieve_followed_milestone_note':'trophy','best_liked_day_feat':'milestone','best_followed_day_feat':'milestone','automattician_achievement':'trophy'},createNoteContainer:function(note,id_prefix){var note_container=$('<div/>',{id:id_prefix+'-note-'+note.id,'class':'wpn-note wpn-'+note.type+' '+((note.unread>0)?'wpn-unread':'wpn-read')}).data({id:parseInt(note.id),type:note.type});var note_body=$('<div/>',{"class":"wpn-note-body wpn-note-body-empty"});var spinner=$('<div/>',{style:'position: absolute; left: 180px; top: 60px;'});note_body.append(spinner);spinner.spin('medium');note_container.append(this.createNoteSubject(note),note_body);return note_container;},createNoteSubject:function(note){var subj=$('<div/>',{"class":"wpn-note-summary"}).append($('<span/>',{"class":'wpn-noticon',html:$('<img/>',{src:note.subject['noticon'],width:'14px',height:'14px',style:'display: inline-block; width: 14px; height: 14px; overflow-x: hidden; overflow-y: hidden;'})}),$('<span/>',{"class":'wpn-icon no-grav',html:$('<img/>',{src:note.subject['icon'],width:'24px',height:'24px',style:'display: inline-block; width: 24px; height: 24px; overflow-x: hidden; overflow-y: hidden;'})}),$('<span/>',{"class":'wpn-subject',html:note.subject['html']}));return subj;},createNoteBody:function(note_model){var note_body=$('<div/>',{"class":"wpn-note-body"});var note=note_model.toJSON();var class_prefix='wpn-'+note.body['template'];switch(note.body['template']){case'single-line-list':case'multi-line-list':note_body.append('<p class="'+class_prefix+'-header">'+note.body['header']+'</p>');for(i in note.body['items']){var item=$('<div></div>',{'class':class_prefix+'-item '+class_prefix+'-item-'+i+
(note.body['items'][i]['icon']?'':' '+class_prefix+'-item-no-icon')});if(note.body['items'][i]['icon']){item.append($('<img/>',{"class":class_prefix+'-item-icon avatar avatar-'+note.body['items'][i]['icon_width'],height:note.body['items'][i]['icon_height'],width:note.body['items'][i]['icon_width'],src:note.body['items'][i]['icon']}));}
if(note.body['items'][i]['header']){item.append($('<div></div>',{'class':class_prefix+'-item-header'}).html(note.body['items'][i]['header']));}
if(note.body['items'][i]['action']){switch(note.body['items'][i]['action']['type']){case'follow':var button=wpFollowButton.create(note.body['items'][i]['action']);item.append(button);button.click(function(e){if($(this).children('a').hasClass('wpcom-follow-rest'))
wpNotesCommon.bumpStat('notes-click-action','unfollow');else
wpNotesCommon.bumpStat('notes-click-action','follow');return true;});break;default:console.error("Unsupported "+note.type+" action: "+note.body['items'][i]['action']['type']);break;}}
if(note.body['items'][i]['html']){item.append($('<div></div>',{'class':class_prefix+'-item-body'}).html(note.body['items'][i]['html']));}
note_body.append(item);}
if(note.body['actions']){var note_actions=new wpNotesCommentModView({model:note_model});var action_el=note_actions.create().el
note_body.append(action_el);}
if(note.body['footer']){note_body.append('<p class='+class_prefix+'-footer">'+note.body['footer']+'</p>');}
break;case'big-badge':if(note.body['header']){note_body.append('<div class="'+class_prefix+'-header">'+note.body['header']+'</div>');}
if(note.body['badge']){note_body.append($('<div></div>',{'class':class_prefix+'-badge '}).append(note.body['badge']));}
if(note.body['html']!=''){note_body.append('<div class="'+class_prefix+'-footer">'+note.body['html']+'</div>');}
break;default:note_body.html('Unsupported note body template!');break;}
note_body.find('a[notes-data-click]').mousedown(function(e){var type=$(this).attr('notes-data-click');wpNotesCommon.bumpStat('notes-click-body',type);return true;});return note_body;},getNoteSubjects:function(query_params,success,fail){query_params.fields='id,type,unread,timestamp,subject';this.getNotes(query_params,success,fail);},getNoteBodies:function(ids,query_params,success,fail){var query_args={};for(i in ids){query_params['ids['+i+']']=ids[i];}
query_params.fields='id,subject,body';this.getNotes(query_params,success,fail);},getNotes:function(query_params,success,fail){this.ajax({type:'GET',path:'/notifications/',data:query_params,success:success,error:fail});},markNotesSeen:function(timestamp){var query_args={time:timestamp};this.ajax({type:'POST',path:'/notifications/seen',data:query_args,success:function(res){},error:function(res){}});},markNotesRead:function(unread_cnts){var query_args={};var t=this;for(var id in unread_cnts){if(unread_cnts[id]>0){query_args['counts['+id+']']=unread_cnts[id];}}
if(0==query_args.length){return;}
this.ajax({type:'POST',path:'/notifications/read',data:query_args,success:function(res){},error:function(res){}});},ajax:function(options){if(document.location.host=='public-api.wordpress.com'){var request={type:options.type,headers:{'Authorization':'X-WPCOOKIE '+cookie+':1:'+document.location.host},url:'https://public-api.wordpress.com/rest/v1'+options.path,success:options.success,error:options.error,data:options.data};$.ajax(request);}else{var request={path:options.path,method:options.type};if(request.method==="POST")
request.body=options.data;else
request.query=options.data;$.wpcom_proxy_request(request,function(response,statusCode){if(200==statusCode)
options.success(response);else
options.error(statusCode);});}},bumpStat:function(group,names){new Image().src=document.location.protocol+'//stats.wordpress.com/g.gif?v=wpcom-no-pv&x_'+
group+'='+names+'&baba='+Math.random();}};wpNoteModel=Backbone.Model.extend({defaults:{summary:"",unread:true},initialize:function(){if(typeof(this.get("subject"))!=="object"){console.error("old style note. id# "+this.id);}},markRead:function(){var unread_cnt=this.get('unread');if(Boolean(parseInt(unread_cnt))){var notes={};notes[this.id]=unread_cnt;wpNotesCommon.markNotesRead(notes);wpNotesCommon.bumpStat('notes-read-type',this.get('type'));}},loadBody:function(){wpNotesCommon.createNoteBody(this);},reload:function(){var t=this;var fields='id,type,unread,subject,body,date,timestamp';var ids=this.get('id');wpNotesCommon.getNotes({fields:fields,ids:ids},function(res){var notes=res.notes;if(typeof notes[0]!=='undefined'){t.set(notes[0]);}},function(){});},resize:function(){this.trigger('resize');}});wpNoteList=Backbone.Collection.extend({model:wpNoteModel,lastMarkedSeenTimestamp:false,mostRecentTimestamp:false,newNotes:false,maxNotes:false,loading:false,bodiesLoaded:false,comparator:function(note){return-note.get('timestamp');},initialize:function(){if(!this.lastMarkedSeenTimestamp&&"undefined"!=typeof(wpn_last_marked_seen_preloaded)){this.lastMarkedSeenTimestamp=parseInt(wpn_last_marked_seen_preloaded);}},addNotes:function(notes){var models=_.map(notes,function(o){return new wpNoteModel(o);});this.add(models);this.sort();if(this.maxNotes){while(this.length>this.maxNotes){this.pop();}}
if(this.length>0)
this.mostRecentTimestamp=parseInt(this.at(0).get('timestamp'));this.trigger('loadNotes:change');},loadNotes:function(query_args){var t=this;t.loading=true;t.trigger('loadNotes:beginLoading');var fields=query_args.fields;var number=parseInt(query_args.number);var before=parseInt(query_args.before);var since=parseInt(query_args.since);var type='undefined'==typeof query_args.type?null:query_args.type;var unread='undefined'==typeof query_args.unread?null:query_args.unread;query_args={};if(!fields){fields='id,type,unread,subject,body,date,timestamp';}
if(isNaN(number)){number=9;}
if(!isNaN(before)){query_args["before"]=before;}
if(!isNaN(since)){query_args["since"]=since;}
if(unread!==null){query_args["unread"]=unread;}
if(type!==null&&type!="unread"&&type!="latest"){query_args["type"]=type;}
query_args["number"]=number;query_args["fields"]=fields;wpNotesCommon.getNotes(query_args,function(res){var notes=res.notes;var notes_changed=false;if(!t.lastMarkedSeenTimestamp||(res.last_seen_time>t.lastMarkedSeenTimestamp)){notes_changed=true;t.lastMarkedSeenTimestamp=parseInt(res.last_seen_time);}
for(var idx in notes){var note_model=t.get(notes[idx].id);if(note_model){if(type){var qt=note_model.get('queried_types')||{};qt[type]=true;notes[idx].queried_types=qt;}
note_model.set(notes[idx]);}
else{if(type){var qt={};qt[type]=true;notes[idx].queried_types=qt;}
note_model=new wpNoteModel(notes[idx])
t.add(note_model);}
if(!note_model.has('body'))
t.bodiesLoaded=false;notes_changed=true;}
if(t.maxNotes){while(t.length>t.maxNotes){t.pop();}}
if(notes_changed){t.sort();if(t.length>0)
t.mostRecentTimestamp=parseInt(t.at(0).get('timestamp'));t.trigger('loadNotes:change');}
t.loading=false;t.trigger('loadNotes:endLoading');},function(res){t.loading=false;});},loadNoteBodies:function(callback){if(this.bodiesLoaded)
return;var t=this;wpNotesCommon.getNoteBodies(this.getNoteIds(),{},function(res){var notes=res.notes;for(var idx in notes){var note_model=t.get(notes[idx].id);if(note_model){note_model.set({body:notes[idx].body,subject:notes[idx].subject});}else{note_model=new wpNoteModel(notes[idx])
t.add(note_model);}}
t.bodiesLoaded=true;if(typeof callback=="function")
callback.call(t);},function(e){console.error('body loading error!');});},markNotesSeen:function(){if(this.mostRecentTimestamp>this.lastMarkedSeenTimestamp){wpNotesCommon.markNotesSeen(this.mostRecentTimestamp);this.lastMarkedSeenTimestamp=false;}},unreadCount:function(){return this.reduce(function(num,note){return num+(note.get('unread')?1:0);},0);},numberNewNotes:function(){var t=this;if(!t.lastMarkedSeenTimestamp)
return 0;var new_notes=this.filter(function(note){return(note.get('timestamp')>t.lastMarkedSeenTimestamp);});return new_notes.length;},getUnreadNotes:function(){return this.filter(function(note){return Boolean(parseInt(note.get("unread")));});},getNotesOfType:function(typeName){var t=this;switch(typeName){case'unread':return t.getUnreadNotes();break;case'latest':return t.filter(function(note){var qt=note.get('queried_types');return'undefined'!=typeof qt&&'undefined'!=typeof qt.latest&&qt.latest;});break;default:return t.filter(function(note){var note_type=note.get("type");if("undefined"==typeof wpNotesCommon.noteTypes[typeName]){return false;}
else if("string"==typeof wpNotesCommon.noteTypes[typeName]){return typeName==note_type;}
var len=wpNotesCommon.noteTypes[typeName].length;for(var i=0;i<len;i++){if(wpNotesCommon.noteTypes[typeName][i]==note_type){return true;}}
return false;});}},getNoteIds:function(){return this.pluck('id');}});wpNotesCommentModView=Backbone.View.extend({mode:'buttons',commentNeedsApproval:false,actionIDMap:{},events:{},templateApproveButton:'\
		<span class="{{class_name}}">\
			<a href="{{ajax_url}}" title="{{title_text}}" data-action-type="{{data_action_type}}"><b>{{text}}</b></a>\
		</span>\
	',templateButton:'\
		<span class="{{class_name}}">\
			<a href="{{ajax_url}}" title="{{title_text}}" data-action-type="{{data_action_type}}">{{text}}</a>\
		</span>\
	',templateReply:'\
		<div class="wpn-note-comment-reply"> \
			<h5>{{reply_header_text}}</h5>\
			<textarea class="wpn-note-comment-reply-text" rows="5" cols="45" name="wpn-note-comment-reply-text"></textarea>\
			<p class="wpn-comment-submit">\
				<img class="wpn-comment-submit-waiting" style="display:none;" src="//s0.wordpress.com/wp-admin/images/wpspin_light.gif" alt="" />\
			<span class="wpn-comment-submit-error" style="display:none;">Error!</span>\
			<a href="{{ajax_url}}" class="wpn-comment-reply-button-send alignright">{{submit_button_text}}</a>\
			<a href="" class="wpn-comment-reply-button-close alignleft">_</a>\
			</p>\
		</div>\
	',initialize:function(){_.bindAll(this,'render');if(!this.model.currentReplyText)
this.model.currentReplyText='';},create:function(){this.setElement($('<div></div>',{'class':'wpn-note-comment-actions'}));this.events['click .wpn-replyto-comment-button-open a']='openReply';this.events['click .wpn-comment-reply-button-close']='closeReply';this.events['click .wpn-comment-reply-button-send']='sendReply';this.events['click .wpn-approve-comment-button a']='modComment';this.events['click .wpn-unapprove-comment-button a']='modComment';this.events['click .wpn-spam-comment-button a']='modComment';this.events['click .wpn-unspam-comment-button a']='modComment';this.events['click .wpn-trash-comment-button a']='modComment';this.events['click .wpn-untrash-comment-button a']='modComment';this.model.bind('change',this.render,this);this.render();return this;},render:function(){this.$el.empty();if(this.mode=='buttons'){this.$el.append.apply(this.$el,this.createActions());}else{this.$el.html(this.createReplyBox());this.$('textarea').focus();}
this.delegateEvents();},createActions:function(){var actions=this.model.get('body').actions;var t=this;var elements=[];this.actionIDMap={};var cnt=0;_.forEach(actions,function(action){t.actionIDMap[action.type]=cnt;switch(action['type']){case'replyto-comment':elements.push(Mustache.render(t.templateButton,{class_name:'wpn-'+action.type+'-button-open',ajax_url:action.params.url,title_text:action.params.button_title_text,data_action_type:action.type,text:action.params.button_text}));elements.push(' | ');break;case'approve-comment':t.commentNeedsApproval=true;elements.push(Mustache.render(t.templateApproveButton,{class_name:'wpn-'+action.type+'-button',ajax_url:action.params.url,title_text:action.params.title_text,data_action_type:action.type,text:action.params.text}));elements.push(' | ');break;case'unapprove-comment':case'spam-comment':case'unspam-comment':case'trash-comment':case'untrash-comment':elements.push(Mustache.render(t.templateButton,{class_name:'wpn-'+action.type+'-button',ajax_url:action.params.url,title_text:action.params.title_text,data_action_type:action.type,text:action.params.text}));elements.push(' | ');break;}
cnt+=1;});elements=elements.slice(0,-1);elements.push($('<img/>',{'class':"wpn-comment-mod-waiting",style:"display:none;",src:"//s0.wordpress.com/wp-admin/images/wpspin_light.gif",alt:""}));return elements;},createReplyBox:function(){var action=this.model.get('body').actions[this.actionIDMap['replyto-comment']];var element=Mustache.render(this.templateReply,{ajax_url:action.params.url,reply_header_text:action.params.reply_header_text,submit_button_text:action.params.submit_button_text});return element;},closeReply:function(ev){if(ev)
ev.preventDefault()
this.mode='buttons';this.model.currentReplyText=this.$el.children('.wpn-note-comment-reply').children('.wpn-note-comment-reply-text').val();this.render();this.model.resize();},openReply:function(ev){ev.preventDefault()
this.mode='reply';this.render();this.$el.children('.wpn-note-comment-reply').children('.wpn-note-comment-reply-text').val(this.model.currentReplyText);this.model.resize();},sendReply:function(ev){ev.preventDefault()
var t=this;var comment_reply_el=this.$el.children('.wpn-note-comment-reply');var comment_text=comment_reply_el.children('.wpn-note-comment-reply-text').val();this.model.currentReplyText=comment_text;var action=this.model.get('body').actions[this.actionIDMap['replyto-comment']];comment_reply_el.children('.wpn-comment-submit').children('.wpn-comment-submit-error').hide();comment_reply_el.children('.wpn-comment-submit').children('.wpn-comment-submit-waiting').show();var args={};if(this.commentNeedsApproval)
args.approve_parent='1';args.comment_ID=action.params.comment_id;args.comment_post_ID=action.params.post_id;args.user_ID=action.params.user_id;args.blog_id=action.params.blog_id;args.action='replyto_comment_note';args['_wpnonce']=action.params.replyto_nonce;args.content=comment_text;$.ajax({type:'POST',url:action.params.ajax_url,data:args,success:function(x){if(typeof(x)=='string'){t.errorReply({'responseText':x});return false;}
t.model.currentReplyText='';t.closeReply(null);t.model.reload();},error:function(r){t.errorReply(r);}});wpNotesCommon.bumpStat('notes-click-action','replyto-comment');},errorReply:function(r){var t=this;var er=r.statusText;var comment_reply_el=this.$el.children('.wpn-note-comment-reply');comment_reply_el.children('.wpn-comment-submit').children('.wpn-comment-submit-waiting').hide();if(r.responseText)
er=r.responseText.replace(/<.[^<>]*?>/g,'');if(er)
comment_reply_el.children('.wpn-comment-submit').children('.wpn-comment-submit-error').html(er).show();},modComment:function(ev){var t=this;ev.preventDefault()
var type=ev.currentTarget.getAttribute('data-action-type');var action_id=this.actionIDMap[type];if(typeof action_id!=='undefined'){var action=this.model.get('body').actions[action_id];var data={'id':action.params.comment_id,'action':action.params.ajax_action,'blog_id':action.params.blog_id,'_blog_nonce':action.params.blog_nonce,'_wpnonce':action.params._wpnonce};data[action.params.ajax_arg]=1;this.$(' .wpn-comment-mod-waiting').show();$.post(action.params.ajax_url,data,function(res){t.model.reload();});wpNotesCommon.bumpStat('notes-click-action',type);}}});})(jQuery);